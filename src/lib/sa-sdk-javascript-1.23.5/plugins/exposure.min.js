sensorsDataAnalytic201505.modules.Exposure=function(){"use strict";function e(){return("MutationObserver"in window||"WebKitMutationObserver"in window||"MozMutationObserver"in window)&&"IntersectionObserver"in window}function t(e){var t={};return n.each(e,function(r,n){switch(n){case"area_rate":r=Number(r),!isNaN(r)&&r>=0&&r<=1?t.area_rate=r:i("parameter config.area_rate error. config:",e);break;case"stay_duration":r=Number(r),!isNaN(r)&&r>=0?t.stay_duration=r:i("parameter config.stay_duration error. config:",e);break;case"repeated":"false"===r||r===!1||"true"===r||r===!0?t.repeated=r:i("parameter config.repeated error. config:",e)}}),t}var r,n,i,a="data-sensors-exposure-event-name",o={},s=[],c={area_rate:0,stay_duration:0,repeated:!0},u={isReady:!1,init:function(a){if(!e())return void i("The current browser does not support the element exposure key API, and the element exposure plugin initialization failed.");var o=this;n.isObject(a)&&(c=n.extend(c,t(a))),n.bindReady(function(){var e=o.getElesByEventName();o.addObserveByNodes(e),d.init()}),r.ee.spa.on("switch",function(e){if(e===location.href)return!1;o.clear();var t=o.getElesByEventName();o.addObserveByNodes(t)}),n.listenPageState({visible:function(){o.start()},hidden:function(){o.stop()}}),this.isReady=!0},getElesByEventName:function(e){return e=e||document,e.querySelectorAll("["+a+"]")},getEleEventName:function(e){return e.getAttribute(a)},getEleAttr:function(e,r){r=r||e.attributes;var i={},a={},o=this.getEleEventName(e);return n.each(r,function(e){var t=e.value;try{var r=e.name.match(/^data-sensors-exposure-property-(.+)/);r&&(i[r[1]]=t)}catch(n){}try{var o=e.name.match(/^data-sensors-exposure-config-(.+)/);if(o)switch(o[1]){case"area_rate":a.area_rate=t;break;case"stay_duration":a.stay_duration=t;break;case"repeated":a.repeated=!1}}catch(n){}}),{eventName:o,config:t(a),properties:i}},addObserveByNodes:function(e){if(e.length){var t=this;n.each(e,function(e){if(1===e.nodeType&&e.hasAttribute(a)){var r=t.getEleAttr(e);r.config=n.extend({},c,r.config),r.ele=e,t.addOrUpdateWatchEle(r)}})}},getIntersection:function(e){var t=null,r=this;return t=o[e.area_rate]?o[e.area_rate]:o[e.area_rate]=new IntersectionObserver(function(){r.exposure.apply(r,arguments)},{threshold:e.area_rate})},exposure:function(e){var t=this;n.each(e,function(e){var i=e.target,a=t.getEleOption(i);return e.isIntersecting===!1||!a||a.config.isSend?void(a&&a.timer&&(clearTimeout(a.timer),a.timer=null)):void(e.intersectionRatio>=a.config.area_rate&&(a.timer&&(clearTimeout(a.timer),a.timer=null),a.timer=setTimeout(function(){var e=i.getBoundingClientRect(),a=t.getEleOption(i);if(e.width&&e.height&&a&&a.eventName&&!a.config.isSend){var o=r.heatmap.getEleDetail(i);r.track(a.eventName,n.extend({},o,a.properties)),a.config.isSend=!0,a.config.repeated&&(a.config.isSend=!1)}},1e3*a.config.stay_duration)))})},getEleOption:function(e){var t=null;return n.each(s,function(r){e===r.ele&&(t=r)}),t},addOrUpdateWatchEle:function(e){var t=e.ele,r=e.config,a=u.getEleOption(t);if(a)n.extend2Lev(a,e),a.config.repeated&&(a.config.isSend=!1);else{if(!e.eventName)return i("parameter option.eventName error. option:",e),!1;n.isElement(t)||i("parameter element error. option:",e);var o=this.getIntersection(r);o.observe(t),s.push(e)}},removeWatchEle:function(e){var t=null,r=-1;if(n.each(s,function(n,i){e===n.ele&&(t=n,r=i)}),t){var i=t.config,a=o[i.area_rate];a&&n.isElement(e)&&(a.unobserve(e),t.timer&&(clearTimeout(t.timer),t.timer=null),r>-1&&s.splice(r,1))}},start:function(){n.each(s,function(e){var t=e.config,r=e.ele,i=o[t.area_rate];i&&n.isElement(r)&&i.observe(r)})},stop:function(){n.each(s,function(e){var t=e.config,r=e.ele,i=o[t.area_rate];i&&n.isElement(r)&&(i.unobserve(r),e.timer&&(clearTimeout(e.timer),e.timer=null))})},clear:function(){this.stop(),o={},s=[]}},d={mo:null,init:function(){var e=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;this.mo=new e(this.listenNodesChange),this.observe()},observe:function(){this.mo.observe(document.body,{attributes:!0,childList:!0,subtree:!0,attributeOldValue:!0})},listenNodesChange:function(e){n.each(e,function(e){switch(e.type){case"childList":e.removedNodes.length>0?n.each(e.removedNodes,function(e){if(1===e.nodeType){u.removeWatchEle(e);var t=u.getElesByEventName(e);t.length&&n.each(t,function(e){u.removeWatchEle(e)})}}):e.addedNodes.length&&(u.addObserveByNodes(e.addedNodes),n.each(e.addedNodes,function(e){if(1===e.nodeType){var t=u.getElesByEventName(e);u.addObserveByNodes(t)}}));break;case"attributes":if(!e.attributeName)return!1;var t=e.target,r=e.attributeName;if(!n.isString(r)||r.indexOf("data-sensors-exposure")<0)return;var i=u.getEleAttr(t,[{name:r}]),a=u.getEleOption(t)||{ele:t,config:c},o=n.extend2Lev({},a,i);Object.prototype.hasOwnProperty.call(o,"eventName")?u.addOrUpdateWatchEle(o):u.removeWatchEle(t)}})}},l={exposureViews:s,init:function(e,t){return!(!e||r)&&(r=e,n=r._,i=r.log,r.on&&r.readyState.state<3?r.on("sdkAfterInitPara",function(){u.init(t)}):u.init(t),void i("Exposure Plugin initialized successfully"))},addExposureView:function(e,r){if(!u.isReady)return void i("Exposure Plugin uninitialized.");if(!n.isElement(e))return void i("parameter element error.");var a={ele:e,config:n.isObject(r.config)?t(r.config):{},eventName:r.eventName,properties:n.isObject(r.properties)?r.properties:{}},o=u.getEleOption(e);if(o){if(o=n.extend2Lev({},o,a),!n.isString(o.eventName)||!o.eventName)return void i("parameter option.eventName error. option",r);o.config.repeated&&(o.config.isSend=!1)}else{if(!n.isString(a.eventName)||!a.eventName)return void i("parameter option.eventName error. option",r);u.addOrUpdateWatchEle(a)}},removeExposureView:function(e){return u.isReady?n.isElement(e)?void u.removeWatchEle(e):void i("removeExposureView parameter ele errors."):void i("Exposure Plugin uninitialized.")}};return window.SensorsDataWebJSSDKPlugin&&"[object Object]"===Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)?window.SensorsDataWebJSSDKPlugin.Exposure=window.SensorsDataWebJSSDKPlugin.Exposure||l:window.SensorsDataWebJSSDKPlugin={Exposure:l},l}();